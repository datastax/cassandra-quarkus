# branch and version of the cassandra-extension to benchmark
branch: "master"
version: "1.0.0-SNAPSHOT"

# Whether or not the DataStax Java driver should use the Netty event loop provided by the Quarkus framework
useQuarkusNettyEventLoop: "true"
---

ensemble:
  server:
    node.count: 3
    provisioner:
      name: ctool
      properties:
        cloud.provider: openstack
        cloud.tenant: performance
        cloud.instance.type: ms1.small
        name: dseserver-cassandra-quarkus-perf
        mark_for_reuse: true
    configuration_manager:
      - name: ctool
        properties:
          java.version: "1.8_151"
          product.type: dse
          product.install.type: tarball
          product.version: 6.7-dev
          enable.graph: false
          json.topology: |
            {
               "cluster":
                {
                  "snitch":"GossipingPropertyFileSnitch",
                  "nodes":
                  {
                    "0":{"datacenter":"datacenter1", "rack":"rack1", "node_type":"Cassandra", "seed":"True"},
                    "1":{"datacenter":"datacenter1", "rack":"rack1", "node_type":"Cassandra", "seed":"True"},
                    "2":{"datacenter":"datacenter1", "rack":"rack1", "node_type":"Cassandra"}
                  }
                }
            }
      - name: ctool_monitoring
        properties:
          components: os,jvm, dse-db, cassandra-all
  observer:
    node.count: 1
    provisioner:
      name: ctool
      properties:
        cloud.tenant: performance
        cloud.instance.type: m1.xlarge
        mark_for_reuse: true
    configuration_manager:
      - name: ctool_monitoring
        properties:
          graphite.create_server: true
  clients:
    - name: cassandra-quarkus-app
      node.count: 1
      provisioner:
        name: ctool
        properties:
          cloud.provider: openstack
          cloud.tenant: performance
          cloud.instance.type: ms1.small
          mark_for_reuse: true
      configuration_manager:
        - name: ctool
          properties:
            install.maven: true
            java.version: openjdk8
        - name: ctool_monitoring
          properties:
            components: os

    - name: http-client
      node.count: 1
      provisioner:
        name: ctool
        properties:
          cloud.provider: openstack
          cloud.tenant: performance
          cloud.instance.type: ms1.small
          mark_for_reuse: true
      configuration_manager:
        - name: ctool
          properties:
            install.maven: true
            java.version: openjdk8
        - name: ctool_monitoring
          properties:
            components: os


workload:
  phases:
    - setup-dse-schema:
        module: cqlsh
        properties:
          num.nodes: 1
          command: >
            CREATE KEYSPACE IF NOT EXISTS k1 WITH replication = {'class':'SimpleStrategy', 'replication_factor':2};
            CREATE TABLE IF NOT EXISTS k1.fruit(store_id text, name text, description text, PRIMARY KEY((store_id), name));
    - clone-and-build-quickstart-app:
        module: bash
        properties:
          target.group: cassandra-quarkus-app
          export_output: false
          script: |
            cd ${FALLOUT_SCRATCH_DIR}
            sudo apt update --assume-yes
            sudo apt-get install lftp --assume-yes

            #install maven and java
            sudo apt install maven --assume-yes
            sudo apt-get install unzip --assume-yes

            git clone -b {{branch}} git@github.com:datastax/cassandra-quarkus.git
            cd cassandra-quarkus
            mvn clean install -DskipTests=true -Dmaven.javadoc.skip=true -B -V
            cd quickstart

            DSE_FIRST_ADDRESS=$(echo ${FALLOUT_SERVER_PRODUCT_CONTACT_POINTS} | cut -d "," -f 1)
            DSE_SECOND_ADDRESS=$(echo ${FALLOUT_SERVER_PRODUCT_CONTACT_POINTS} | cut -d "," -f 2)
            DSE_THIRD_ADDRESS=$(echo ${FALLOUT_SERVER_PRODUCT_CONTACT_POINTS} | cut -d "," -f 3)
            DSE_ADDRESSES="${DSE_FIRST_ADDRESS}:9042, ${DSE_SECOND_ADDRESS}:9042, ${DSE_THIRD_ADDRESS}:9042"
            sed -i "s/127.0.0.1:9042/$DSE_ADDRESSES/g" src/main/resources/application.properties

            # compile and start quickstart app
            mvn clean package
            java -jar ./target/cassandra-quarkus-quickstart-1.0.0-SNAPSHOT-runner.jar &> ${FALLOUT_ARTIFACT_DIR}/quickstart.log